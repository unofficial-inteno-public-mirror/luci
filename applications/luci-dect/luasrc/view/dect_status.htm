<%+header%>

<script type="text/javascript">//<![CDATA[


  function clear_table(table) {
      var rows = table.rows;
      var i = rows.length;
      while (--i) {
	  if (rows[i].style.display != "none")
	      rows[i].parentNode.removeChild(rows[i]);
      }
  }


  function button_click(handset) {

      alert("Ping " + handset);
  }


  // function update_table(table, handset, st) {
      
      
  //     var row=table.insertRow(handset + 1);
  //     var cell1=row.insertCell(-1);
  //     var cell2=row.insertCell(-1);
  //     var cell3=row.insertCell(-1);
  //     var cell4=row.insertCell(-1);
  //     var cell5=row.insertCell(-1);
      
  //     cell1.innerHTML=st.handsets[handset].handset;
  //     cell2.innerHTML=st.handsets[handset].rfpi;
  //     cell3.innerHTML=st.handsets[handset].present;
      
  //     var buttonnode= document.createElement('input');
  //     buttonnode.setAttribute('type','button');
  //     buttonnode.setAttribute('name', handset + 1);
  //     buttonnode.setAttribute('value', 'ping');
  //     buttonnode.onclick=function(){ping_hset(this.name)};
  //     cell4.appendChild(buttonnode);
      
  //     var deletenode= document.createElement('input');
  //     deletenode.setAttribute('type','button');
  //     deletenode.setAttribute('name', handset + 1);
  //     deletenode.setAttribute('value','delete');
  //     deletenode.onclick=function(){delete_hset(this.name)};
  //     cell5.appendChild(deletenode);
      
  // }
  

  function handsets_has_hst(handsets, hst) {
      
      for (var i = 0; i < handsets.length; i++) {
      	  if (hst == handsets[i].handset)
      	      return true;
      }
      return false;

  }


  function delete_missing_rows(table, handsets) {

      for (var i = 1; i < table.rows.length; i++) {
  	  var hst=table.rows[i].cells[0].innerHTML;
	  
  	  if (handsets_has_hst(handsets, hst) == false)
	      table.deleteRow(i);
      }
  }


  function table_has_handset(table, h) {
      for (var i = 0; i < table.rows.length; i++) {
      	  var hst=table.rows[i].cells[0].innerHTML;
      	  if (hst == h.handset)
      	      return true;
      }
      return false;
  }


  function handset_get_row(table, handset) {
      for (var i = 0; i < table.rows.length; i++) {
      	  var hst=table.rows[i].cells[0].innerHTML;
      	  if (hst == handset)
	      return table.rows[i];
      }
  }


  function update_handsets(table, handsets) {

      for (var i = 0; i < handsets.length; i++) {

	  var row = handset_get_row(table, handsets[i].handset);
	  row.cells[2].innerHTML = handsets[i].present;
      }
  }


  function table_add_handset(table, h) {

      var i;
      
      for (i = 1; i < table.rows.length; i++) {
	  var hst=table.rows[i].cells[0].innerHTML;
	  
	  if (hst > h.handset)
	      break;
      }

      var row=table.insertRow(i);
      var cell1=row.insertCell(-1);
      var cell2=row.insertCell(-1);
      var cell3=row.insertCell(-1);
      var cell4=row.insertCell(-1);
      var cell5=row.insertCell(-1);
      
      cell1.innerHTML=h.handset;
      cell2.innerHTML=h.rfpi;
      cell3.innerHTML=h.present;
      
      var buttonnode= document.createElement('input');
      buttonnode.setAttribute('type','button');
      buttonnode.setAttribute('name', h.handset);
      buttonnode.setAttribute('value', 'ping');
      buttonnode.onclick=function(){ping_hset(this.name)};
      cell4.appendChild(buttonnode);
      
      var deletenode= document.createElement('input');
      deletenode.setAttribute('type','button');
      deletenode.setAttribute('name', h.handset);
      deletenode.setAttribute('value','delete');
      deletenode.onclick=function(){delete_hset(this.name)};
      cell5.appendChild(deletenode);

  }


  function add_new_rows(table, handsets) {

      for (var i = 0; i < handsets.length; i++) {
	  if(table_has_handset(table, handsets[i]) == false)
	     table_add_handset(table, handsets[i]);
      }
      
  }


  function activate_reg() {

      var rm=document.getElementById("registration_mode");

      rm.innerHTML = "Enabling...";
      
      var xmlhttp;
      if (window.XMLHttpRequest)
      {// code for IE7+, Firefox, Chrome, Opera, Safari
	  xmlhttp=new XMLHttpRequest();
      }
      else
      {// code for IE6, IE5
	  xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
      }
      xmlhttp.onreadystatechange=function()
      {
	  if (xmlhttp.readyState==4 && xmlhttp.status==200)
	  {
	      
	  }
      }
      xmlhttp.open("GET","<%=luci.dispatcher.build_url("admin/services/dect/reg_start")%>",true);
      xmlhttp.send();
  }

  
  

  function delete_hset(handset) {

      var table=document.getElementById("dect_status_table");
      
      var row = handset_get_row(table, handset);
      row.style.display = "none";

      var xmlhttp;
      if (window.XMLHttpRequest)
      {// code for IE7+, Firefox, Chrome, Opera, Safari
	  xmlhttp=new XMLHttpRequest();
      }
      else
      {// code for IE6, IE5
	  xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
      }
      xmlhttp.onreadystatechange=function()
      {
	  if (xmlhttp.readyState==4 && xmlhttp.status==200)
	  {

	      
	  }
      }
      xmlhttp.open("GET","<%=luci.dispatcher.build_url("admin/services/dect/delete_hset/")%>?handset=" + handset,true);
      xmlhttp.send();
  }


  function ping_hset(handset) {

      var xmlhttp;
      if (window.XMLHttpRequest)
      {// code for IE7+, Firefox, Chrome, Opera, Safari
	  xmlhttp=new XMLHttpRequest();
      }
      else
      {// code for IE6, IE5
	  xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
      }
      xmlhttp.onreadystatechange=function()
      {
	  if (xmlhttp.readyState==4 && xmlhttp.status==200)
	  {

	      
	  }
      }
      xmlhttp.open("GET","<%=luci.dispatcher.build_url("admin/services/dect/ping_hset/")%>?handset=" + handset,true);
      xmlhttp.send();
  }

  
  // Polling background thread
  XHR.poll(1, '<%=luci.dispatcher.build_url("admin/services/dect/status")%>', null,
	   function(x, st) {

	       var rm=document.getElementById("registration_mode");
	       if (st.reg_active == true) {
		   rm.innerHTML = "Enabled";
	       } else if (rm.innerHTML != "Enabling...") {
		   rm.innerHTML = "Disabled";
	       }
	       
	       var table=document.getElementById("dect_status_table");
	       
	       // Delete missing rows
	       delete_missing_rows(table, st.handsets);
	       
	       // Add new rows
	       add_new_rows(table, st.handsets);

	       // Update existing rows
	       update_handsets(table, st.handsets);

	   }
	  );
    
</script>


</head>


<body>

<fieldset class="cbi-section">
	<legend><b>Registration</b></legend>
	<table class="cbi-section-table">
	  <tr>
	    <td class="cbi-section-table-cell">Registration mode</td>
	    <td class="cbi-section-table-cell" id="registration_mode">Collecting data...</td>
	    <td class="cbi-section-table-cell"><input type='button' onClick="activate_reg()" value='Register DECT' id='strBtn'></td>
	  </tr>
	</table>

	<!-- <p><input type='button' onClick="activate_reg()" value='Register DECT' id='strBtn'> -->
	<!--   <div id="dect_status">Collecting data...</div> -->
</br>
</p>

</fieldset>

<fieldset class="cbi-section">
	<legend>Dect Status</legend>
	<table class="cbi-section-table" id="dect_status_table">
	  <tr class="cbi-section-table-titles">
	    <th class="cbi-section-table-cell">Handset</th>
	    <th class="cbi-section-table-cell">RFPI</th>
	    <th class="cbi-section-table-cell">Present</th>
	    <th class="cbi-section-table-cell">Ping</th>
	    <th class="cbi-section-table-cell">Delete</th>
	  </tr>
	  <!-- <tr class="cbi-section-table-row"> -->
	  <!--   <td colspan="5" id="hset1"><em><br />Collecting data...</em></td> -->
	  <!-- </tr> -->
	</table>
</fieldset>



</body>

<%+footer%>
